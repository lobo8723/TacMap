<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project - Final Stable Version</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: #111; font-family: monospace; color: #00ff00; }
    #map { height: 100%; width: 100%; z-index: 0; }
    #address {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 6px 10px;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.85);
      color: #00ff00;
      z-index: 999;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    #satBtn {
      position: absolute;
      top: 28px;
      left: 10px;
      z-index: 999;
      background: black;
      color: #00ff00;
      border: 1px solid #00ff00;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
    }
    #checkinBox {
      position: absolute;
      top: 60px;
      left: 10px;
      z-index: 999;
      background: rgba(0, 0, 0, 0.9);
      padding: 10px;
      border: 2px solid #00ff00;
      max-width: 300px;
    }
    #checkinBox h3, #checkinBox p, #checkinBox button {
      margin: 4px 0;
      font-size: 12px;
    }
    #viewLog, #resetLog {
      background: black;
      color: #00ff00;
      border: 1px solid #00ff00;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    #logData {
      color: orange;
      font-size: 11px;
      margin-top: 6px;
    }
    .hud {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0,0,0,0.9);
      padding: 6px 8px;
      box-sizing: border-box;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 999;
      flex-wrap: wrap;
      font-size: 12px;
    }
    .hud span, .hud button {
      margin: 2px 6px;
    }
    .hud button {
      background: black;
      color: #00ff00;
      border: 1px solid #00ff00;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="address">LOCATING...</div>
  <button id="satBtn">SATELLITE VIEW</button>
  <div id="checkinBox">
    <div><strong>CHECK-INS:</strong> <span id="checkCount">0</span> | <strong>LAST:</strong> <span id="lastTime">--:--:--</span></div>
    <div><strong>MOVE:</strong> <span id="stepCount">0</span> steps | <strong>DISTANCE:</strong> <span id="distCount">0</span>m</div>
    <button id="viewLog">[VIEW LOG]</button>
    <div id="logSection" style="display:none;">
      <div>LOG:</div>
      <div id="logData"></div>
      <button id="resetLog">[RESET LOG]</button>
    </div>
  </div>
  <div class="hud">
    <span id="gpsStatus">GPS: WAITING...</span>
    <span id="clock">TIME: --:--:--</span>
    <button onclick="clearMarkers()">[CLEAR MARKERS]</button>
    <button onclick="doCheckIn()">[CHECK-IN]</button>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([33.4484, -112.0740], 19);
    const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const sat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      subdomains:['mt0','mt1','mt2','mt3'], maxZoom: 20
    });
    let usingStreet = true;
    document.getElementById('satBtn').onclick = () => {
      map.removeLayer(usingStreet ? street : sat);
      usingStreet ? sat.addTo(map) : street.addTo(map);
      document.getElementById('satBtn').textContent = usingStreet ? 'MAP VIEW' : 'SATELLITE VIEW';
      usingStreet = !usingStreet;
    };
    
    const markerGroup = L.layerGroup().addTo(map);
    let lastLatLng = null, checkCount = 0, totalSteps = 0, totalDistance = 0, logEntries = [];

    navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude, accuracy } = pos.coords;
      const latlng = [latitude, longitude];
      if (accuracy > 20) {
        document.getElementById('gpsStatus').textContent = `GPS: REJECTED (${Math.round(accuracy)}m)`;
        return;
      }
      document.getElementById('gpsStatus').textContent = `GPS: LOCKED (${Math.round(accuracy)}m)`;
      document.getElementById('address').textContent = 'LOCATING...';
      fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('address').textContent = data.display_name;
        }).catch(() => {
          document.getElementById('address').textContent = `Lat: ${latitude.toFixed(5)}, Lon: ${longitude.toFixed(5)}`;
        });
      map.setView(latlng, 19);
      if (lastLatLng) {
        const dist = map.distance(lastLatLng, latlng);
        if (dist >= 1) {
          totalSteps++;
          totalDistance += Math.round(dist);
          document.getElementById('stepCount').textContent = totalSteps;
          document.getElementById('distCount').textContent = totalDistance;
          L.circleMarker(latlng, { radius: 4, color: '#00ff00', fillColor: '#00ff00', fillOpacity: 1 }).addTo(markerGroup);
        }
      }
      lastLatLng = latlng;
    }, () => {
      document.getElementById('gpsStatus').textContent = 'GPS: ERROR';
    }, { enableHighAccuracy: true });

    function clearMarkers() {
      markerGroup.clearLayers();
    }

    function doCheckIn() {
      checkCount++;
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      const steps = totalSteps, dist = totalDistance;
      logEntries.push(`${String(checkCount).padStart(2, '0')} — ${timeStr} — ${steps} steps — ${dist}m`);
      document.getElementById('checkCount').textContent = checkCount;
      document.getElementById('lastTime').textContent = timeStr;
      updateLog();
    }

    function updateLog() {
      document.getElementById('logData').innerHTML = logEntries.map(entry => `<div>${entry}</div>`).join('');
    }

    document.getElementById('viewLog').onclick = () => {
      const logSection = document.getElementById('logSection');
      logSection.style.display = logSection.style.display === 'none' ? 'block' : 'none';
    };

    document.getElementById('resetLog').onclick = () => {
      checkCount = 0; totalSteps = 0; totalDistance = 0; logEntries = [];
      document.getElementById('checkCount').textContent = 0;
      document.getElementById('stepCount').textContent = 0;
      document.getElementById('distCount').textContent = 0;
      document.getElementById('lastTime').textContent = '--:--:--';
      updateLog();
    };

    setInterval(() => {
      const now = new Date();
      document.getElementById('clock').textContent = "TIME: " + now.toLocaleString();
    }, 1000);
  </script>
</body>
</html>