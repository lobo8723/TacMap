<!-- ========================= -->
<!-- PART 1: NEW REPORT PANEL STYLES -->
<!-- ========================= -->
<style>
  /* REPORT PANEL TOGGLE BUTTON (BOTTOM HUD) */
  .hud .reportToggleBtn {
    background-color: #17a2b8;
    color: white;
    border: none;
    padding: 8px 14px;
    font-size: 13px;
    border-radius: 4px;
    cursor: pointer;
    margin: 2px 6px;
  }

  /* FULLSCREEN REPORT PANEL */
  #reportPanel {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #fff;
    z-index: 3000;
    overflow-y: auto;
    padding: 20px 16px;
    box-sizing: border-box;
  }

  #reportPanel h2 {
    text-align: center;
    margin-top: 0;
    font-size: 18px;
    color: #007bff;
  }

  #reportPanel input,
  #reportPanel button,
  #reportPanel textarea {
    width: 100%;
    font-size: 13px;
    padding: 8px;
    margin-top: 8px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  #reportPanel label {
    margin-top: 12px;
    font-weight: bold;
    display: block;
    font-size: 13px;
  }

  #reportPanel .btnRow {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 12px;
  }

  #closeReportBtn {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 10px;
    font-size: 14px;
    border-radius: 4px;
    margin-top: 20px;
    width: 100%;
    cursor: pointer;
  }
</style>

<!-- CONTINUES IN PART 2: HTML panel structure & toggle button -->
<!-- ========================= -->
<!-- PART 2: REPORT PANEL HTML + TOGGLE -->
<!-- ========================= -->

<!-- FULLSCREEN REPORT PANEL -->
<div id="reportPanel">
  <h2>Field Activity Report</h2>

  <!-- Officer Info -->
  <label for="officerNamePanel">Officer</label>
  <input type="text" id="officerNamePanel" placeholder="Enter officer name">

  <label for="postLocationPanel">Location</label>
  <input type="text" id="postLocationPanel" placeholder="Enter post/post address">

  <!-- Stats -->
  <label>Stats</label>
  <div><strong>Check-Ins:</strong> <span id="panelCheckCount">0</span></div>
  <div><strong>Last Check-In:</strong> <span id="panelLastTime">--:--:--</span></div>
  <div><strong>Steps:</strong> <span id="panelStepCount">0</span> | <strong>Distance:</strong> <span id="panelDistCount">0</span>m</div>

  <!-- Log Controls -->
  <div class="btnRow">
    <button onclick="viewPanelLog()">[VIEW LOG]</button>
    <button onclick="exportLog()">[EXPORT LOG]</button>
    <button onclick="resetLog()">[RESET LOG]</button>
  </div>

  <button id="closeReportBtn" onclick="toggleReportPanel(false)">Close Panel</button>
</div>

<!-- ADD BUTTON TO BOTTOM HUD -->
<script>
  // Append [+ REPORT PANEL] button dynamically
  window.onload = function () {
    const hud = document.querySelector('.hud');
    const reportBtn = document.createElement('button');
    reportBtn.textContent = "+ REPORT PANEL";
    reportBtn.className = "reportToggleBtn";
    reportBtn.onclick = () => toggleReportPanel(true);
    hud.insertBefore(reportBtn, hud.children[hud.children.length - 1]);

    // existing localStorage restore logic...
        // CONTINUE RESTORING DATA INTO PANEL FIELDS
    const saved = localStorage.getItem("tacMapData");
    if (saved) {
      const parsed = JSON.parse(saved);
      steps = parsed.steps || 0;
      totalDist = parsed.totalDist || 0;
      checkIns = parsed.checkIns || 0;
      checkLog = parsed.checkLog || [];
      checkNotes = parsed.checkNotes || [];
      trail = parsed.trail || [];

      document.getElementById('stepCount').textContent = steps;
      document.getElementById('distCount').textContent = totalDist;
      document.getElementById('checkCount').textContent = checkIns;
      document.getElementById('lastTime').textContent = parsed.lastTime || "--:--:--";
      document.getElementById('officerName').value = parsed.officer || '';
      document.getElementById('postLocation').value = parsed.location || '';

      // ALSO SYNC REPORT PANEL FIELDS
      document.getElementById('panelStepCount').textContent = steps;
      document.getElementById('panelDistCount').textContent = totalDist;
      document.getElementById('panelCheckCount').textContent = checkIns;
      document.getElementById('panelLastTime').textContent = parsed.lastTime || "--:--:--";
      document.getElementById('officerNamePanel').value = parsed.officer || '';
      document.getElementById('postLocationPanel').value = parsed.location || '';

      updateLog();
    }
  };
</script>

<!-- CONTINUES IN PART 4: toggle logic, syncing fields, and saving on close -->
<!-- ========================= -->
<!-- PART 4: TOGGLE PANEL + SYNC FIELDS -->
<!-- ========================= -->
<script>
  function toggleReportPanel(show) {
    const panel = document.getElementById('reportPanel');
    panel.style.display = show ? 'block' : 'none';

    if (!show) {
      // sync back to main fields when closing
      document.getElementById('officerName').value = document.getElementById('officerNamePanel').value;
      document.getElementById('postLocation').value = document.getElementById('postLocationPanel').value;
      saveData();
    } else {
      // sync current data to panel when opening
      document.getElementById('panelStepCount').textContent = steps;
      document.getElementById('panelDistCount').textContent = totalDist;
      document.getElementById('panelCheckCount').textContent = checkIns;
      document.getElementById('panelLastTime').textContent = document.getElementById('lastTime').textContent;
      document.getElementById('officerNamePanel').value = document.getElementById('officerName').value;
      document.getElementById('postLocationPanel').value = document.getElementById('postLocation').value;
    }
  }

  function viewPanelLog() {
    document.getElementById('logSection').style.display = 'block';
    toggleReportPanel(false);
  }
</script>

<!-- CONTINUES IN PART 5: minor style adjustment + functionality isolation -->
<!-- ========================= -->
<!-- PART 5: ISOLATE PANEL LOGIC & PRESERVE CLEAN LAYOUT -->
<!-- ========================= -->

<style>
  /* OVERRIDE CONFLICTS IF ANY */
  #checkinBox {
    display: block;
  }

  /* PREVENT MAP BEHIND PANEL FROM SCROLLING */
  body.modal-open {
    overflow: hidden;
  }
</style>

<script>
  // Lock scroll when panel is open
  function toggleReportPanel(show) {
    const panel = document.getElementById('reportPanel');
    panel.style.display = show ? 'block' : 'none';
    document.body.classList.toggle('modal-open', show);

    if (!show) {
      document.getElementById('officerName').value = document.getElementById('officerNamePanel').value;
      document.getElementById('postLocation').value = document.getElementById('postLocationPanel').value;
      saveData();
    } else {
      document.getElementById('panelStepCount').textContent = steps;
      document.getElementById('panelDistCount').textContent = totalDist;
      document.getElementById('panelCheckCount').textContent = checkIns;
      document.getElementById('panelLastTime').textContent = document.getElementById('lastTime').textContent;
      document.getElementById('officerNamePanel').value = document.getElementById('officerName').value;
      document.getElementById('postLocationPanel').value = document.getElementById('postLocation').value;
    }
  }
</script>

<!-- CONTINUES IN PART 6: syncing export PDF with panel inputs -->
<!-- ========================= -->
<!-- PART 6: PDF EXPORT USES PANEL FIELDS IF VISIBLE -->
<!-- ========================= -->
<script>
  function exportLog() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Prefer values from the report panel if it's open
    const officer = document.getElementById("officerNamePanel").value || document.getElementById("officerName").value || "--";
    const location = document.getElementById("postLocationPanel").value || document.getElementById("postLocation").value || "--";

    let y = 10;
    doc.setFont("helvetica", "bold");
    doc.setFillColor(40, 40, 40);
    doc.setTextColor(255, 255, 255);
    doc.rect(10, y, 190, 10, "F");
    doc.setFontSize(16);
    doc.text("PATROL LOG", 105, y + 7, { align: "center" });
    y += 20;

    const fields = [
      ["Officer Name", officer],
      ["Location", location],
      ["Total Check-Ins", String(checkIns)],
      ["Total Distance", `${totalDist} meters`],
      ["Total Steps", String(steps)],
      ["Last Check-In", document.getElementById("lastTime").textContent]
    ];

    doc.setFontSize(11);
    for (let i = 0; i < fields.length; i += 2) {
      doc.setFont("helvetica", "bold");
      doc.setTextColor(0);
      doc.text(`${fields[i][0]}:`, 10, y);
      if (fields[i + 1]) doc.text(`${fields[i + 1][0]}:`, 105, y);

      doc.setFont("helvetica", "normal");
      doc.setTextColor(33, 33, 33);
      doc.text(fields[i][1], 60, y);
      if (fields[i + 1]) doc.text(fields[i + 1][1], 150, y);
      y += 8;
    }

    // CONTINUES IN PART 7: narrative log & auto page breaks
</script>
<!-- ========================= -->
<!-- PART 7: PDF LOG NARRATIVE SECTION -->
<!-- ========================= -->
<script>
    y += 4;
    doc.setFont("helvetica", "bold");
    doc.setFillColor(220, 220, 220);
    doc.setTextColor(0);
    doc.rect(10, y, 190, 8, "F");
    doc.text("Narrative Log", 12, y + 6);
    y += 14;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);

    for (let i = 0; i < checkLog.length; i++) {
      const entry = checkLog[i].replace(/\n/g, '\n');
      const note = checkNotes[i] ? `Note: ${checkNotes[i]}` : "Note: --";
      const block = entry + "\n" + note;

      const lines = doc.splitTextToSize(block, 180);
      if (y + lines.length * 6 > 270) {
        doc.addPage();
        y = 10;
      }

      doc.text(lines, 10, y);
      y += lines.length * 6 + 4;
    }

    const timestamp = new Date().toLocaleString();
    doc.setFontSize(8);
    doc.setTextColor(100);
    doc.text(`Generated on ${timestamp}`, 200, 290, { align: "right" });

    doc.save("patrol_log.pdf");
  }
</script>
<!-- ========================= -->
<!-- PART 8: saveData() UPDATES BOTH INPUT SETS -->
<!-- ========================= -->
<script>
  function saveData() {
    const officerVal = document.getElementById('officerName').value || document.getElementById('officerNamePanel').value;
    const locationVal = document.getElementById('postLocation').value || document.getElementById('postLocationPanel').value;

    localStorage.setItem("tacMapData", JSON.stringify({
      steps,
      totalDist,
      checkIns,
      checkLog,
      checkNotes,
      trail,
      lastTime: document.getElementById('lastTime').textContent,
      officer: officerVal,
      location: locationVal
    }));
  }
</script>
<!-- ========================= -->
<!-- PART 9: UNIFIED RESET & LOG FUNCTIONS -->
<!-- ========================= -->
<script>
  function resetLog() {
    checkIns = 0;
    checkLog = [];
    checkNotes = [];
    roundStartTime = null;

    document.getElementById('checkCount').textContent = 0;
    document.getElementById('panelCheckCount').textContent = 0;

    document.getElementById('lastTime').textContent = '--:--:--';
    document.getElementById('panelLastTime').textContent = '--:--:--';

    document.getElementById('logData').innerHTML = '';
    saveData();
  }

  function updateStats() {
    document.getElementById('stepCount').textContent = steps;
    document.getElementById('panelStepCount').textContent = steps;
    document.getElementById('distCount').textContent = totalDist;
    document.getElementById('panelDistCount').textContent = totalDist;
  }

  function updateLog() {
    const container = document.getElementById('logData');
    container.innerHTML = checkLog.map((line, i) => {
      const note = checkNotes[i] || '--';
      return `<div>${line}<br><strong>Note:</strong> ${note}<br><button class="editNoteBtn" onclick="editNote(${i})">Edit Note</button></div><br>`;
    }).join('');
  }
</script>
<!-- ========================= -->
<!-- PART 10: MODULE FINALIZER & CLEAN EXIT -->
<!-- ========================= -->
<script>
  // ========== SYSTEM FINALIZER ==========
  console.log("Fullscreen Report Panel integrated successfully.");

  // Optionally auto-close panel on ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      toggleReportPanel(false);
    }
  });
</script>
</body>
</html>
