<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project 1 - Final Stable Version (v1.1R13 - Fully Functional)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: monospace; background: #111; color: #00ff00; }
    #map { width: 100%; height: 100%; z-index: 1; position: absolute; top: 0; left: 0; }
    .hud { position: absolute; width: 100%; bottom: 0; background: rgba(0,0,0,0.85); padding: 8px; box-sizing: border-box; z-index: 999; }
    .hud-row { display: flex; justify-content: space-between; flex-wrap: wrap; font-size: 12px; }
    #gpsBtn { position: absolute; right: 10px; top: 60px; background: black; border: 1px solid #00ff00; color: #00ff00; padding: 4px 8px; font-size: 12px; z-index: 1001; }
    #address { position: absolute; top: 0; left: 0; padding: 5px 10px; font-size: 12px; background: rgba(0,0,0,0.8); color: #00ff00; z-index: 999; }
    #timer { position:absolute;top:115px;left:10px;z-index:999;font-size:12px;background:rgba(0,0,0,0.7);padding:4px 6px;font-weight:bold;border:1px solid #00ff00; }
    #photoDropdown { display: none; flex-wrap: wrap; gap: 6px; margin-top: 6px; padding-top: 4px; border-top: 1px solid #00ff00; }
    #photoDropdown img { width: 120px; height: auto; object-fit: contain; border: 1px solid #00ff00; }
    #actionMenuWrapper { text-align: center; margin-top: 6px; }
    #actionDropdownBtn { background:black;color:#00ff00;border:1px solid #00ff00;padding:5px 12px;cursor:pointer;font-size:12px;min-width:150px; }
    #actionDropdownContent { display: none; flex-wrap: wrap; gap: 6px; justify-content: center; padding: 6px 0; }
    #actionDropdownContent button { background: black; color: #00ff00; border: 1px solid #00ff00; padding: 5px 12px; cursor: pointer; font-size: 12px; min-width: 140px; }
    #helpModal { display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: black; border: 1px solid #00ff00; color: #00ff00; padding: 15px; width: 90%; max-width: 500px; z-index: 2000; overflow-y: auto; max-height: 80vh; }
    #helpModal h2 { font-size: 16px; margin-top: 0; }
    #helpModal ul { padding-left: 20px; font-size: 12px; }
    #closeHelp { background: black; color: #00ff00; border: 1px solid #00ff00; padding: 4px 10px; cursor: pointer; float: right; font-size: 12px; }
  </style>
</head>
<body>
  <div id="loadingOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;
    background:black;color:#00ff00;z-index:3000;display:flex;flex-direction:column;
    justify-content:center;align-items:center;font-family:monospace;">
    <h2 id="loadingText" style="font-size:22px;margin-bottom:10px;">SYSTEM LOADING...</h2>
    <div id="bootTimestamp" style="font-size:12px;color:#00ff00;margin-bottom:8px;">
      Boot started at <span id="startTime"></span>
    </div>
    <div style="position:relative;width:80%;height:20px;margin-bottom:20px;">
      <div style="position:absolute;top:0;left:0;width:100%;height:100%;border:1px solid #00ff00;">
        <div id="progressBar" style="height:100%;width:0%;background:#00ff00;transition:width 0.4s linear;"></div>
      </div>
      <div id="progressPercent" style="position:absolute;width:100%;height:100%;
        display:flex;justify-content:center;align-items:center;font-size:14px;
        color:#ffff00;font-weight:bold;">0%</div>
    </div>
    <div id="bootLog" style="width:80%;max-height:200px;overflow-y:auto;
      text-align:left;font-size:14px;border-top:1px solid #00ff00;padding-top:10px;">
    </div>
    <button id="helpBtn" style="margin-top:10px;background:black;color:#00ff00;
      border:1px solid #00ff00;padding:6px 12px;font-size:12px;cursor:pointer;display:none;">
      Diagnostics Help
    </button>
  </div>

  <audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    let bootStartTime, currentStep=0, loadingComplete=false, gpsLocked=false;
    const failures=[];

    const steps = [
      { name:"Checking Local Data Storage", fn:() => { try{localStorage.setItem('x','1');localStorage.removeItem('x');return true;}catch{return false;} }, tip:"Enable browser storage permissions." },
      { name:"Checking Local Session Storage", fn:() => { try{sessionStorage.setItem('x','1');sessionStorage.removeItem('x');return true;}catch{return false;} }, tip:"Enable session storage." },
      { name:"Verifying Internet Connection", fn: async () => {
          try { const res = await fetch('https://jsonplaceholder.typicode.com/posts/1'); return res.ok; } catch { return false; }
        }, tip:"Check network/cellular connectivity." },
      { name:"Pinging Map Servers", fn: async () => {
          try { const res = await fetch('https://tile.openstreetmap.org/0/0/0.png'); return res.ok; } catch { return false; }
        }, tip:"OSM tile server unreachable." },
      { name:"Pinging Satellite Servers", fn: async () => {
          try { const res = await fetch('https://mt0.google.com/vt/lyrs=s&x=0&y=0&z=1'); return res.ok; } catch { return false; }
        }, tip:"Satellite tile server unreachable." },
      { name:"Detecting Device Type", fn:() => true, tip:null },
      { name:"Checking Available Memory", fn:() => navigator.deviceMemory? navigator.deviceMemory*1024>=500 : true, tip:"Close other apps to free memory." },
      { name:"Checking Camera Access", fn:() => !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia), tip:"Grant camera permissions." },
      { name:"Checking Battery Status", fn: async () => {
          if (!navigator.getBattery) return true;
          const b = await navigator.getBattery();
          return b.level*100 >= 20;
        }, tip:"Charge device; low battery may halt operations." },
      { name:"Syncing System Clock", fn:() => {
          const local=new Date(), utc=new Date(local.getTime()+local.getTimezoneOffset()*60000);
          return Math.abs(Date.now()-utc.getTime())/1000 < 300;
        }, tip:"Sync device clock within 5 minutes." },
      { name:"Connecting to GPS Module", fn: async () => {
          return new Promise(resolve => {
            navigator.geolocation.getCurrentPosition(
              pos => resolve(pos.coords.accuracy <= 20),
              () => resolve(false),
              { enableHighAccuracy:true, timeout:7000, maximumAge:0 }
            );
          });
        }, tip:"Enable GPS & grant location permission." }
    ];

    const el = {
      bar:()=>document.getElementById('progressBar'),
      pct:()=>document.getElementById('progressPercent'),
      log:()=>document.getElementById('bootLog'),
      help:()=>document.getElementById('helpBtn'),
      beep:()=>document.getElementById('beepSound')
    };

    function logMsg(text,color="#00ff00"){
      const t=((performance.now()-bootStartTime)/1000).toFixed(3);
      const div=document.createElement('div');
      div.style.color=color;
      div.textContent=`${text} (${t}s)`;
      el.log().appendChild(div);
      el.log().scrollTop=el.log().scrollHeight;
    }

    async function runSteps(){
      for(const step of steps){
        const ok=await step.fn();
        logMsg(`${step.name} ... [${ok?"OK":"FAIL"}]`, ok?"#00ff00":"red");
        if(!ok && step.tip){
          failures.push(step.tip);
          el.help().style.display='block';
        }
        currentStep++;
        const pct=Math.floor((currentStep/steps.length)*100);
        el.bar().style.width=pct+'%';
        el.pct().textContent=pct+'%';
        await new Promise(r=>setTimeout(r,700));
      }
      completeBoot();
    }

    function completeBoot(){
      if(loadingComplete) return;
      loadingComplete=true;
      el.bar().style.width='100%';
      el.pct().textContent='100%';
      el.beep().play().catch(()=>{});
      el.help().onclick=()=>{
        alert("Diagnostics Help:\\n"+failures.map(f=>"• "+f).join("\\n"));
      };
      setTimeout(()=>{
        document.getElementById('loadingOverlay').style.transition="opacity 1.5s ease";
        document.getElementById('loadingOverlay').style.opacity=0;
        setTimeout(()=>document.getElementById('loadingOverlay').style.display='none',1500);
      },1000);
    }

    window.addEventListener('DOMContentLoaded',()=>{
      bootStartTime=performance.now();
      document.getElementById('startTime').textContent=new Date().toLocaleTimeString();
      setTimeout(runSteps,800);
    });
  </script>

  <div id="map"></div>
  <div id="gpsBtn" title="Center on GPS">[GPS]</div>
  <button id="toggleMapType" style="position:absolute;top:50px;left:10px;z-index:999;background:black;color:#00ff00;border:1px solid #00ff00;padding:5px;font-size:12px;">SATELLITE VIEW</button>
  <div id="timer">Active Time: 00:00:00</div>
  <div id="address">LOCATING...</div>
  <div class="hud">
    <div class="hud-row">
      <div>OFFICER: <input id="officer" type="text" placeholder="Enter Officer Name" style="background:black;color:#00ff00;border:none;" inputmode="text" /></div>
      <div id="clock">TIME: --:--:--</div>
      <div id="gpsStatus">GPS: WAITING...</div>
      <div id="markerCount">MARKERS: 0</div>
    </div>
    <div id="actionMenuWrapper">
      <button id="actionDropdownBtn">[ ACTION MENU ]</button>
      <div id="actionDropdownContent">
        <button onclick="setMarkerMode('clear')">[SECURE]</button>
        <button onclick="setMarkerMode('incident')">[INCIDENT]</button>
        <button onclick="setMarkerMode('move')">[MOVEMENT]</button>
        <button onclick="setMarkerMode('custom')">[ADD CUSTOM]</button>
        <button onclick="clearAll()">[CLEAR MARKERS]</button>
        <button onclick="takePhoto()">[CAPTURE]</button>
        <button onclick="toggleDropdown()">[VIEW PHOTOS]</button>
        <button onclick="showHelp()">[HELP]</button>
      </div>
    </div>
  <div id="photoDropdown"></div>
  </div>
  <div id="helpModal">
    <button id="closeHelp" onclick="document.getElementById('helpModal').style.display='none'">CLOSE</button>
    <h2>Help Reference Guide</h2>
    <ul>
      <li><strong>[SECURE]</strong>: Green marker for secured areas.</li>
      <li><strong>[INCIDENT]</strong>: Red marker to flag incidents.</li>
      <li><strong>[MOVEMENT]</strong>: Orange marker for movement tracking.</li>
      <li><strong>[ADD CUSTOM]</strong>: Enter a label to create a custom marker.</li>
      <li><strong>[CLEAR MARKERS]</strong>: Remove all placed markers.</li>
      <li><strong>[CAPTURE]</strong>: Opens the camera to take a photo.</li>
      <li><strong>[VIEW PHOTOS]</strong>: Shows uploaded or captured photos.</li>
      <li><strong>[SATELLITE VIEW]</strong>: Switch between satellite/street map.</li>
      <li><strong>[Active Time]</strong>: Timer showing operation duration.</li>
      <li><strong>[GPS]</strong>: Zooms to current GPS location.</li>
      <li><strong>[Address]</strong>: Reverse geocoded physical address.</li>
      <li><strong>[OFFICER]</strong>: Enter officer name.</li>
      <li><strong>[GPS LOCKED]</strong>: Displays GPS signal accuracy.</li>
      <li><strong>[TIME]</strong>: Shows system time in real-time.</li>
      <li><strong>[MARKERS]</strong>: Active marker counter.</li>
    </ul>
  </div>
  <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none;" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([33.4484, -112.0740], 19);
    const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
      maxZoom: 20
    });
    let currentLayer = street;
    street.addTo(map);

    // ─── LIVE INCIDENT CALLS FOR SERVICE ───
    fetch(
      'https://api.allorigins.win/raw?url=' +
      encodeURIComponent('https://data.phoenix.gov/resource/t6hg-eeb8.json?$order=call_date_time DESC&$limit=50')
    )
      .then(res => res.text())
      .then(text => {
        const calls = JSON.parse(text);
        console.log('911 Calls:', calls);
        calls.forEach(call => {
          const lat = parseFloat(call.latitude),
                lon = parseFloat(call.longitude);
          if (isNaN(lat) || isNaN(lon)) return;
          L.circleMarker([lat, lon], {
            radius: 6,
            color: 'red',
            fillColor: '#ff4444',
            fillOpacity: 0.7,
            weight: 1
          })
          .bindTooltip(
            `<strong>${call.call_type}</strong><br>` +
            `${new Date(call.call_date_time).toLocaleString()}<br>` +
            `${call.address || ''}`
          )
          .addTo(map);
        });
      })
      .catch(err => console.error('Fetch error:', err));
    // ───────────────────────────────────────

    function setMarkerMode(type) { /* … */ }
    function showHelp() { /* … */ }
    document.getElementById('toggleMapType').onclick = () => { /* … */ };
    map.on('click', function (e) { /* … */ });
    function clearAll() { /* … */ }
    function takePhoto() { /* … */ }
    document.getElementById('photoInput').addEventListener('change', function() { /* … */ });
    function toggleDropdown() { /* … */ }
    document.getElementById('gpsBtn').onclick = () => { /* … */ };
    document.getElementById('actionDropdownBtn').onclick = () => { /* … */ };
    document.getElementById('officer').addEventListener('change', function () { /* … */ });
    function initGPS() { /* … */ }
    initGPS();
    setInterval(() => { /* timer update */ }, 1000);
    setInterval(() => { /* clock update */ }, 1000);
  </script>
</body>
</html>