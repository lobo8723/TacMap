<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project 1 - Final Stable Version (v1.1R13 - Fully Functional)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: monospace; background: #111; color: #00ff00; }
    #map { width: 100%; height: 100%; z-index: 1; position: absolute; top: 0; left: 0; }
    .hud { position: absolute; width: 100%; bottom: 0; background: rgba(0,0,0,0.85); padding: 8px; box-sizing: border-box; z-index: 999; }
    .hud-row { display: flex; justify-content: space-between; flex-wrap: wrap; font-size: 12px; }
    #gpsBtn { position: absolute; right: 10px; top: 60px; background: black; border: 1px solid #00ff00; color: #00ff00; padding: 4px 8px; font-size: 12px; z-index: 1001; }
    #address { position: absolute; top: 0; left: 0; padding: 5px 10px; font-size: 12px; background: rgba(0,0,0,0.8); color: #00ff00; z-index: 999; }
    #timer { position:absolute;top:115px;left:10px;z-index:999;font-size:12px;background:rgba(0,0,0,0.7);padding:4px 6px;font-weight:bold;border:1px solid #00ff00; }
    #photoDropdown { display: none; flex-wrap: wrap; gap: 6px; margin-top: 6px; padding-top: 4px; border-top: 1px solid #00ff00; }
    #photoDropdown img { width: 120px; height: auto; object-fit: contain; border: 1px solid #00ff00; }
    #actionMenuWrapper { text-align: center; margin-top: 6px; }
    #actionDropdownBtn { background:black;color:#00ff00;border:1px solid #00ff00;padding:5px 12px;cursor:pointer;font-size:12px;min-width:150px; }
    #actionDropdownContent { display: none; flex-wrap: wrap; gap: 6px; justify-content: center; padding: 6px 0; }
    #actionDropdownContent button { background: black; color: #00ff00; border: 1px solid #00ff00; padding: 5px 12px; cursor: pointer; font-size: 12px; min-width: 140px; }
    #helpModal { display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: black; border: 1px solid #00ff00; color: #00ff00; padding: 15px; width: 90%; max-width: 500px; z-index: 2000; overflow-y: auto; max-height: 80vh; }
    #helpModal h2 { font-size: 16px; margin-top: 0; }
    #helpModal ul { padding-left: 20px; font-size: 12px; }
    #closeHelp { background: black; color: #00ff00; border: 1px solid #00ff00; padding: 4px 10px; cursor: pointer; float: right; font-size: 12px; }
  </style>
</head>
<body>
  <!-- TACTICAL SYSTEM BOOT OVERLAY -->
<div id="loadingOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;
background:black;color:#00ff00;z-index:3000;display:flex;flex-direction:column;
justify-content:center;align-items:center;font-family:monospace;">
  <h2 id="loadingText" style="font-size:22px;margin-bottom:20px;">SYSTEM LOADING...</h2>
  <div style="position:relative;width:80%;height:20px;margin-bottom:20px;">
    <div style="position:absolute;top:0;left:0;width:100%;height:100%;border:1px solid #00ff00;">
      <div id="progressBar" style="height:100%;width:0%;background:#00ff00;transition:width 0.4s linear;"></div>
    </div>
    <div id="progressPercent" style="position:absolute;width:100%;height:100%;
    display:flex;justify-content:center;align-items:center;font-size:14px;
    color:#ffff00;font-weight:bold;">0%</div>
  </div>
  <div id="bootLog" style="width:80%;max-height:200px;overflow-y:auto;
  text-align:left;font-size:14px;border-top:1px solid #00ff00;padding-top:10px;">
  </div>
</div>

<!-- Hidden Audio Element -->
<audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<style>
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}
</style>

<script>
const loadingSteps = [
  "Initializing Map Display...",
  "Activating HUD Systems...",
  "Checking Local Data Storage...",
  "Checking Local Session Storage...",
  "Verifying Internet Connection...",
  "Pinging Map Servers...",
  "Pinging Satellite Servers...",
  "Detecting Device Type...",
  "Checking Available Memory...",
  "Checking Camera Access...",
  "Checking Battery Status...",
  "Syncing System Clock...",
  "Connecting to GPS Module..."
];

let gpsLocked = false;
let gpsRetryInterval = null;
let loadingComplete = false;
let currentStep = 0;

function progressBar() { return document.getElementById('progressBar'); }
function progressPercent() { return document.getElementById('progressPercent'); }
function bootLog() { return document.getElementById('bootLog'); }
function beepSound() { return document.getElementById('beepSound'); }

function logMessage(text, color="#00ff00") {
  const msg = document.createElement('div');
  msg.style.color = color;
  msg.textContent = text;
  bootLog().appendChild(msg);
  bootLog().scrollTop = bootLog().scrollHeight;
}

function tryGPS() {
  navigator.geolocation.getCurrentPosition(
    () => { gpsLocked = true; },
    () => { gpsLocked = false; },
    { enableHighAccuracy:true, timeout:5000, maximumAge:0 }
  );
}

function testInternet() {
  const start = Date.now();
  return fetch('https://www.google.com/favicon.ico',{mode:'no-cors'})
    .then(() => {
      const latency = Date.now() - start;
      let strength = 100 - Math.min(latency,300)/3;
      return Math.max(10,Math.min(100,Math.floor(strength)));
    })
    .catch(() => 0);
}

function pingMapServer() {
  return fetch('https://tile.openstreetmap.org/0/0/0.png',{mode:'no-cors'})
    .then(()=>true).catch(()=>false);
}

function pingSatelliteServer() {
  return fetch('https://mt0.google.com/vt/lyrs=s&x=0&y=0&z=1',{mode:'no-cors'})
    .then(()=>true).catch(()=>false);
}

function checkStorage() {
  try { localStorage.setItem('test','1'); localStorage.removeItem('test'); return true; }
  catch { return false; }
}

function checkSessionStorage() {
  try { sessionStorage.setItem('test','1'); sessionStorage.removeItem('test'); return true; }
  catch { return false; }
}

function checkCamera() {
  return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
}

function getDeviceType() {
  const ua = navigator.userAgent.toLowerCase();
  return /(mobile|android|iphone)/.test(ua) ? "MOBILE" : "DESKTOP";
}

function checkBattery() {
  return navigator.getBattery
    ? navigator.getBattery().then(b => Math.floor(b.level*100))
    : Promise.resolve(null);
}

function checkMemory() {
  return navigator.deviceMemory ? navigator.deviceMemory*1024 : null;
}

function checkClockSync() {
  const local = new Date(), utc = new Date(local.getTime() + local.getTimezoneOffset()*60000);
  return Math.abs(Date.now()-utc.getTime())/1000 < 300;
}

function updateProgress() {
  const pct = Math.floor((currentStep/(loadingSteps.length+1))*100);
  progressBar().style.width = pct+'%';
  progressPercent().textContent = pct+'%';
}

async function nextStep() {
  if (currentStep >= loadingSteps.length) {
    if (gpsLocked) return completeBoot();
    logMessage("Waiting for GPS Signal...", "#ffff00");
    gpsRetryInterval = setInterval(() => {
      tryGPS();
      if (gpsLocked) {
        clearInterval(gpsRetryInterval);
        logMessage("GPS Module Lock [OK]", "#00ff00");
        completeBoot();
      }
    }, 3000);
    return;
  }

  const step = loadingSteps[currentStep];

  if (step.includes("Local Data Storage"))
    logMessage(step + (checkStorage() ? " [OK]" : " [FAIL]"), checkStorage()?"#00ff00":"red");
  else if (step.includes("Session Storage"))
    logMessage(step + (checkSessionStorage() ? " [OK]" : " [FAIL]"), checkSessionStorage()?"#00ff00":"red");
  else if (step.includes("Internet Connection")) {
    const strength = await testInternet();
    logMessage(`Internet Connection [${strength}% ${strength>0?"OK":"FAIL"}]`, strength>0?"#00ff00":"red");
  }
  else if (step.includes("Map Servers"))
    logMessage(step + (await pingMapServer()?" [OK]":" [FAIL]"), "#00ff00");
  else if (step.includes("Satellite Servers"))
    logMessage(step + (await pingSatelliteServer()?" [OK]":" [FAIL]"), "#00ff00");
  else if (step.includes("Device Type"))
    logMessage(`Device Detected: ${getDeviceType()}`, "#00ff00");
  else if (step.includes("Checking Available Memory")) {
    const mem = checkMemory();
    logMessage(mem!==null?`Available Memory: ${mem} MB`:"Available Memory: Unknown", mem>=500?"#00ff00":"yellow");
  }
  else if (step.includes("Camera Access"))
    logMessage(step + (checkCamera()?" [READY]":" [NOT READY]"), checkCamera()?"#00ff00":"red");
  else if (step.includes("Battery Status")) {
    const bat = await checkBattery();
    logMessage(bat!==null?`Battery Status: ${bat}%`:"Battery Status: N/A", bat>=20?"#00ff00":"yellow");
  }
  else if (step.includes("Syncing System Clock"))
    logMessage(`System Clock [${checkClockSync()?"OK":"WARNING: OUT OF SYNC"}]`, checkClockSync()?"#00ff00":"yellow");
  else
    logMessage(step + " [OK]", "#00ff00");

  currentStep++;
  updateProgress();
  setTimeout(nextStep, 700);
}

function completeBoot() {
  if (loadingComplete) return;
  loadingComplete = true;
  progressBar().style.width = '100%';
  progressPercent().textContent = '100%';
  beepSound().play().catch(()=>{});
  setTimeout(() => {
    document.getElementById('loadingOverlay').style.transition = "opacity 1.5s ease";
    document.getElementById('loadingOverlay').style.opacity = 0;
    setTimeout(() => {
      document.getElementById('loadingOverlay').style.display = 'none';
    }, 1500);
  }, 1000);
}

window.addEventListener('DOMContentLoaded', () => {
  setTimeout(nextStep, 800);
});
</script>
  <div id="map"></div>
  <div id="gpsBtn" title="Center on GPS">[GPS]</div>
  <button id="toggleMapType" style="position:absolute;top:50px;left:10px;z-index:999;background:black;color:#00ff00;border:1px solid #00ff00;padding:5px;font-size:12px;">SATELLITE VIEW</button>
  <div id="timer">Active Time: 00:00:00</div>
  <div id="address">LOCATING...</div>
  <div class="hud">
    <div class="hud-row">
      <div>OFFICER: <input id="officer" type="text" placeholder="Enter Officer Name" style="background:black;color:#00ff00;border:none;" inputmode="text" /></div>
      <div id="clock">TIME: --:--:--</div>
      <div id="gpsStatus">GPS: WAITING...</div>
      <div id="markerCount">MARKERS: 0</div>
    </div>
    <div id="actionMenuWrapper">
      <button id="actionDropdownBtn">[ ACTION MENU ]</button>
      <div id="actionDropdownContent">
        <button onclick="setMarkerMode('clear')">[SECURE]</button>
        <button onclick="setMarkerMode('incident')">[INCIDENT]</button>
        <button onclick="setMarkerMode('move')">[MOVEMENT]</button>
        <button onclick="setMarkerMode('custom')">[ADD CUSTOM]</button>
        <button onclick="clearAll()">[CLEAR MARKERS]</button>
        <button onclick="takePhoto()">[CAPTURE]</button>
        <button onclick="toggleDropdown()">[VIEW PHOTOS]</button>
        <button onclick="showHelp()">[HELP]</button>
      </div>
    </div>
    <div id="photoDropdown"></div>
  </div>
  <div id="helpModal">
    <button id="closeHelp" onclick="document.getElementById('helpModal').style.display='none'">CLOSE</button>
    <h2>Help Reference Guide</h2>
    <ul>
      <li><strong>[SECURE]</strong>: Green marker for secured areas.</li>
      <li><strong>[INCIDENT]</strong>: Red marker to flag incidents.</li>
      <li><strong>[MOVEMENT]</strong>: Orange marker for movement tracking.</li>
      <li><strong>[ADD CUSTOM]</strong>: Enter a label to create a custom marker.</li>
      <li><strong>[CLEAR MARKERS]</strong>: Remove all placed markers.</li>
      <li><strong>[CAPTURE]</strong>: Opens the camera to take a photo.</li>
      <li><strong>[VIEW PHOTOS]</strong>: Shows uploaded or captured photos.</li>
      <li><strong>[SATELLITE VIEW]</strong>: Switch between satellite/street map.</li>
      <li><strong>[Active Time]</strong>: Timer showing operation duration.</li>
      <li><strong>[GPS]</strong>: Zooms to current GPS location.</li>
      <li><strong>[Address]</strong>: Reverse geocoded physical address.</li>
      <li><strong>[OFFICER]</strong>: Enter officer name.</li>
      <li><strong>[GPS LOCKED]</strong>: Displays GPS signal accuracy.</li>
      <li><strong>[TIME]</strong>: Shows system time in real-time.</li>
      <li><strong>[MARKERS]</strong>: Active marker counter.</li>
    </ul>
  </div>
  <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none;" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([33.4484, -112.0740], 19);
    const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
  maxZoom: 20
});
    let currentLayer = street;
    street.addTo(map);
    let markerGroup = L.layerGroup().addTo(map);
    let trail = [], markerCount = 0, markerMode = null, startTime = Date.now();
    let breadcrumbMode = false;

    function setMarkerMode(type) {
      markerMode = type;
      alert("Tap on the map to place marker.");
    }

    function showHelp() {
      document.getElementById('helpModal').style.display = 'block';
    }

    document.getElementById('toggleMapType').onclick = () => {
      map.removeLayer(currentLayer);
      currentLayer = currentLayer === street ? satellite : street;
      currentLayer.addTo(map);
      document.getElementById('toggleMapType').textContent = currentLayer === street ? 'SATELLITE VIEW' : 'MAP VIEW';
    };

    map.on('click', function (e) {
      if (breadcrumbMode) {
        const m = L.circleMarker(e.latlng, {
          radius: 2, color: '#00ff00', fillColor: '#00ff00', fillOpacity: 1
        }).bindTooltip("BREADCRUMB").addTo(markerGroup);
        return;
      }
      if (!markerMode) return;
      let label = markerMode.toUpperCase();
      let color = markerMode === 'clear' ? 'green' :
                  markerMode === 'incident' ? 'red' :
                  markerMode === 'move' ? '#ffaa00' : 'cyan';
      if (markerMode === 'custom') {
        const custom = prompt("Enter custom label:");
        if (!custom) return;
        label = custom;
      }
      const m = L.circleMarker(e.latlng, {
        radius: 6, color: color, fillColor: color, fillOpacity: 1
      }).bindTooltip(label).addTo(markerGroup);
      markerCount++;
      document.getElementById('markerCount').textContent = `MARKERS: ${markerCount}`;
      markerMode = null;
    });

    function clearAll() {
      markerGroup.clearLayers();
      markerCount = 0;
      trail = [];
      document.getElementById('markerCount').textContent = "MARKERS: 0";
    }

    function takePhoto() {
      document.getElementById('photoInput').click();
    }

    document.getElementById('photoInput').addEventListener('change', function() {
      const file = this.files[0];
      if (!file) return;
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      document.getElementById('photoDropdown').appendChild(img);
    });

    function toggleDropdown() {
      const panel = document.getElementById('photoDropdown');
      panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'flex' : 'none';
    }

    document.getElementById('gpsBtn').onclick = () => {
      if (trail.length > 0) {
        const last = trail[trail.length - 1];
        map.setView(last, map.getZoom());
      } else {
        alert("GPS location not yet available.");
      }
    };

    document.getElementById('actionDropdownBtn').onclick = () => {
      const menu = document.getElementById('actionDropdownContent');
      menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'flex' : 'none';
    };

    document.getElementById('officer').addEventListener('change', function () {
      const value = this.value.trim().toLowerCase();
      if (value === 'deltaon') {
        breadcrumbMode = true;
        alert('🟢 Breadcrumb Mode Activated');
      } else if (value === 'deltaoff') {
        breadcrumbMode = false;
        alert('🔴 Breadcrumb Mode Deactivated');
      }
    });

    function initGPS() {
      navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        if (accuracy > 20) {
          document.getElementById('gpsStatus').textContent = `GPS: REJECTED (${Math.round(accuracy)}m)`;
          return;
        }
        document.getElementById('gpsStatus').textContent = `GPS: LOCKED (${Math.round(accuracy)}m)`;
        const latlng = [latitude, longitude];
        trail.push(latlng);
        L.circleMarker(latlng, {
          radius: 2, color: '#00ff00', fillColor: '#00ff00', fillOpacity: 1
        }).addTo(markerGroup);
        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`)
          .then(res => res.json())
          .then(data => {
            document.getElementById('address').textContent = data.display_name || `Lat: ${latitude.toFixed(5)}, Lon: ${longitude.toFixed(5)}`;
          }).catch(() => {
            document.getElementById('address').textContent = `Lat: ${latitude.toFixed(5)}, Lon: ${longitude.toFixed(5)}`;
          });
      }, err => {
        document.getElementById('gpsStatus').textContent = "GPS: ERROR";
      }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
      });
    }

    initGPS();

    setInterval(() => {
      let now = Date.now() - startTime;
      let hrs = Math.floor(now / 3600000);
      let mins = Math.floor((now % 3600000) / 60000);
      let secs = Math.floor((now % 60000) / 1000);
      document.getElementById('timer').textContent = "Active Time: " +
        String(hrs).padStart(2, '0') + ":" +
        String(mins).padStart(2, '0') + ":" +
        String(secs).padStart(2, '0');
    }, 1000);

    setInterval(() => {
      const now = new Date();
      document.getElementById('clock').textContent = "TIME: " + now.toLocaleString();
    }, 1000);
  </script>
</body>
</html>
